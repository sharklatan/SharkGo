# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: Win

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Cache .NET SDK
        uses: actions/cache@v2
        with:
          path: ${{ env.USERPROFILE }}\.dotnet\tools
          key: dotnet-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            dotnet-
            
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.x' # Usa la versiÃ³n apropiada
          
      - name: Cache .NET packages
        uses: actions/cache@v2
        with:
          path: ~/.nuget/packages
          key: dotnet-${{ runner.os }}-${{ hashFiles('**/*.csproj.lock') }}
          restore-keys: |
            dotnet-${{ runner.os }}-

      - name: Build and Publish .NET 6.0
        run: |
          cd SharkGo
          dotnet restore
          dotnet build --configuration Release --framework net6.0
          dotnet publish --configuration Release --framework net6.0 --output ./publish/net6.0

      - name: Compress Files
        run: |
          #ls -R 
          cd ./SharkGo/publish/net6.0
          Compress-Archive -Path gpx, runtimes, Aspose.GIS.dll, Fleck.dll, ICSharpCode.SharpZipLib.dll, iMobileDevice-net.dll, Newtonsoft.Json.dll, plist-cil.dll, SharkGo.deps.json, SharkGo.dll, SharkGo.exe, SharkGo.pdb, SharkGo.runtimeconfig.json -DestinationPath ../../SharkGoFiles.zip
          cd ../..

      - name: List files in publish directory
        run: ls -R ./SharkGo

      - name: Upload Release Artifact .NET 6.0 and Compressed Files
        uses: actions/upload-artifact@v2
        with:
          name: release-artifact-net6.0
          path: |
            ./SharkGo/publish

      - name: Get Last Commit
        id: last_commit
        run: echo "commit=$(git log -1 --pretty=format:'%h - %s')" >> $GITHUB_OUTPUT

      - name: Get Last Push Date
        id: last_push
        run: echo "push_date=$(git log -1 --pretty=format:'%cd' --date=short)'" >> $GITHUB_OUTPUT

      - name: Create and Upload Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./SharkGo/SharkGoFiles.zip
          tag_name: Beta
          name: "Beta Release - ${{ steps.last_push.outputs.push_date }}"
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
